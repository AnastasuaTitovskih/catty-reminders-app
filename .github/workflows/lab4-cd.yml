name: ðŸš€ Lab 4 - Docker Compose Deploy

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Debug info
      run: |
        echo "ðŸ”§ Lab 4 - Docker Compose Deployment"
        echo "Trigger: ${{ github.event_name }}"
        echo "Release: ${{ github.event.release.tag_name }}"
    
    - name: Deploy via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: course.prafdin.ru
        port: 2475
        username: nopressure
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "=== Lab 4: Docker Compose Deployment ==="
          echo "Release: ${{ github.event.release.tag_name }}"
          
          cd ~/my-app
          
                    
          echo "2. Logging in to GitHub Container Registry..."
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          echo "3. Pulling Docker image from GHCR..."
          docker pull ghcr.io/anastasuatitovskih/catty-reminders-app:lab4-docker-compose
          
          echo "4. Stopping old Docker Compose stack..."
          docker-compose down || true
          
          echo "5. Starting new Docker Compose stack..."
          docker-compose up -d
          
          sleep 10
          
          echo "6. Checking services..."
          docker-compose ps
          docker-compose logs --tail=10
          
          echo "âœ… Docker Compose stack deployed!"
          echo "ðŸ“¡ Application: http://app.titovskih.course.prafdin.ru"
          echo "ðŸŽ¯ Lab 4 completed: Multi-container with Docker Compose"
