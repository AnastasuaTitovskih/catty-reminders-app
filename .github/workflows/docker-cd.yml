name: üöÄ Lab 3 - Docker Deploy

on:
  push:
    branches: [ docker-lab3 ]
    paths:
      - 'Dockerfile'
      - 'app/**'
      - 'requirements.txt'
      - '.github/workflows/docker-cd.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Debug info
      run: |
        echo "üîß Lab 3 - Docker Deployment"
        echo "Branch: ${{ github.ref }}"
        echo "Using SSH key from GitHub Secrets"
    
    - name: Deploy via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: course.prafdin.ru
        port: 2475
        username: nopressure
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "=== Lab 3: Docker Deployment ==="
          echo "Branch: ${{ github.ref }}"
          echo "User: $(whoami)"
          echo "Directory: $(pwd)"
          
          # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞
          cd /home/nopressure/my-app
          
          # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–µ—Ç–∫—É docker-lab3
          git fetch origin
          git checkout docker-lab3
          git pull origin docker-lab3
          
          # –°–æ–±–∏—Ä–∞–µ–º Docker –æ–±—Ä–∞–∑
          echo "Building Docker image..."
          docker build -t catty-reminders:lab3 .
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
          echo "Stopping old container..."
          docker stop catty-reminders || true
          docker rm catty-reminders || true
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π
          echo "Starting new container..."
          docker run -d \
            --name catty-reminders \
            --restart unless-stopped \
            -p 8181:8181 \
            catty-reminders:lab3
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º
          sleep 5
          echo "=== Verification ==="
          docker ps | grep catty-reminders
          echo "‚úÖ Lab 3 deployed successfully!"
          echo "üì° Available at: http://app.titovskih.course.prafdin.ru"
